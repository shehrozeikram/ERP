🚀 Starting ZKTeco Real-Time Attendance Service...
📡 This will start the push server for real-time attendance updates

✅ Connected to MongoDB
🚀 Starting ZKTeco Push server...
🚀 Starting ZKTeco Push SDK server...
🚀 Starting MongoDB Change Stream monitoring for PURE real-time updates...
🚀 Starting PURE real-time attendance monitoring...
📡 Attempting MongoDB Change Stream for instant attendance updates...
✅ Change stream monitoring active - ready for INSTANT updates!
✅ Real-time attendance monitoring started successfully
📡 Monitoring ALL attendance changes instantly
🎉 ZKTeco Push SDK server started successfully!
✨ PURE REAL-TIME MODE: Database changes broadcast INSTANTLY!
📋 Next steps:
   1. Configure ZKTeco device to send push notifications to:
      http://your-server-ip:8080/zkteco/push
   2. Real-time attendance will appear instantly in the Attendance module
   3. WebSocket clients will receive live updates
   4. Database changes monitored via MongoDB Change Streams
✅ Push server started successfully!
📡 Push endpoint: http://localhost:8080/zkteco/push
🔍 Health check: http://localhost:8080/zkteco/health

🎉 Real-time attendance service is now running!

📋 Next Steps:
   1. Open Attendance Management → Real-Time Attendance tab
   2. Configure your ZKTeco device to send push notifications to:
      http://your-server-ip:8080/zkteco/push
   3. Real-time attendance will appear instantly when employees check in/out

⏹️  To stop the service, press Ctrl+C

❌ WebSocket server error: Error: listen EADDRINUSE: address already in use :::8080
    at Server.setupListenHandle [as _listen2] (node:net:1817:16)
    at listenInCluster (node:net:1865:12)
    at Server.listen (node:net:1953:7)
    at ZKTecoPushService.startPushServer (/Users/shehroze/Documents/My Web Projects/Node js Projects/SGC_ERP/server/services/zktecoPushService.js:102:23)
    at startRealTimeService (/Users/shehroze/Documents/My Web Projects/Node js Projects/SGC_ERP/server/scripts/startRealTimeService.js:30:49)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5) {
  code: 'EADDRINUSE',
  errno: -48,
  syscall: 'listen',
  address: '::',
  port: 8080
}
❌ Change stream error: MongoServerError: The $changeStream stage is only supported on replica sets
    at Connection.onMessage (/Users/shehroze/Documents/My Web Projects/Node js Projects/SGC_ERP/node_modules/mongodb/lib/cmap/connection.js:202:26)
    at MessageStream.<anonymous> (/Users/shehroze/Documents/My Web Projects/Node js Projects/SGC_ERP/node_modules/mongodb/lib/cmap/connection.js:61:60)
    at MessageStream.emit (node:events:517:28)
    at processIncomingData (/Users/shehroze/Documents/My Web Projects/Node js Projects/SGC_ERP/node_modules/mongodb/lib/cmap/message_stream.js:124:16)
    at MessageStream._write (/Users/shehroze/Documents/My Web Projects/Node js Projects/SGC_ERP/node_modules/mongodb/lib/cmap/message_stream.js:33:9)
    at writeOrBuffer (node:internal/streams/writable:392:12)
    at _write (node:internal/streams/writable:333:10)
    at Writable.write (node:internal/streams/writable:337:10)
    at Socket.ondata (node:internal/streams/readable:809:22)
    at Socket.emit (node:events:517:28) {
  ok: 0,
  code: 40573,
  codeName: 'Location40573',
  [Symbol(errorLabels)]: Set(0) {}
}
🔄 Falling back to high-frequency polling...
📡 Starting high-frequency polling for near-instant attendance updates...
🔄 Using intelligent polling since Change Streams require replica sets
✅ High-frequency polling active - checking every 2 seconds for instant updates!
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Mohammad Ali
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Musa Kaleem Ullah
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Muhammad Ansar Khan
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Mansoor Zareen
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Mansoor Zareen
📡 No WebSocket clients connected
🔥 Found 1 recent updates - broadcasting instantly!
📤 Broadcasting update for: Shahzad Khan
📡 No WebSocket clients connected
🔥 Found 2 recent updates - broadcasting instantly!
📤 Broadcasting update for: Aamir Munir
📡 No WebSocket clients connected
📤 Broadcasting update for: Sardar Shehroze Ikram
📡 No WebSocket clients connected
